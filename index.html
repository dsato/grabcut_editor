<html lang="ja">

<script>

	function rect_mode_change(rect_mode) {
		let mode = document.getElementById(rect_mode);
		radioNodeList = mode.elements['rect_mode'];
		let checkValue = radioNodeList.value;
		switch (checkValue) {
			case 'rect':
				rect_mask_mode = 0;
				break;
			case 'bg':
				rect_mask_mode = 1;
				break;
			case 'fg':
				rect_mask_mode = 2;
				console.log(rect_mask_mode)
				break;
			default:
				console.log('Sorry, we are out of ${expr}.');
		}
	}

	function load_to_canvas(files, img_1, canvas_1_1, canvas_1_2, canvas_2) {
		canvas1_1 = document.getElementById(canvas_1_1);
		canvas1_2 = document.getElementById(canvas_1_2);
		canvas2 = document.getElementById(canvas_2);

		canvas1_2.addEventListener('mousemove', onMove, false);
		canvas1_2.addEventListener('mousedown', onClick, false);

		let reader = new FileReader();
		let image = new Image();
		reader.onloadend = function (event) {
			image.src = reader.result;
			image.onload = function () {
				canvas1_1.width = image.width;
				canvas1_1.height = image.height;
				canvas1_2.width = image.width;
				canvas1_2.height = image.height;
				canvas2.width = image.width;
				canvas2.height = image.height;
				window_w = image.width;
				window_h = image.height;
				canvas2.style.left = canvas1_2.width;
				//const gray_img = new ImageData(canvas1_2.width, canvas1_2.height);
				//for (let i = 0, n = gray_img.data.length; i < n; i += 4) {
				//	gray_img.data[i] = 128;
				//	gray_img.data[i+1] = 128;
				//	gray_img.data[i+2] = 128;
				//	gray_img.data[i+3] = 0;
				//}
				//let ctx = canvas1_2.getContext("2d");
				//ctx.putImageData(gray_img, 0, 0);

				const black_img = new ImageData(canvas2.width, canvas2.height);
				for (let i = 0, n = black_img.data.length; i < n; i += 4) {
					black_img.data[i+3] = 255;
				}
				ctx = canvas2.getContext("2d");
				ctx.putImageData(black_img, 0, 0);
				image_copy = image.src
			}
			document.getElementById(img_1).setAttribute('src', event.target.result);

		}
		reader.readAsDataURL(files[0]);
		

	}
	const API_SERVER = 'https://awh.tiby.work:1443';
	let canvas1_1
	let canvas1_2
	let canvas2
	let window_x = 0;
	let window_y = 0;
	let window_w = 0;
	let window_h = 0;
	let click_x = 0;
	let click_y = 0;
	let image_copy

	let rect_mask_mode = 0;	// 0 -> rect; 1 -> mask bg; 2 -> mask fg

	function onClick(e) {
		if (canvas1_2.getContext) {
			if (e.buttons == 1) {	//左クリック
				if (rect_mask_mode == 0) {
					let ctx = canvas1_1.getContext('2d');
					let rect = e.target.getBoundingClientRect();
					click_x = e.clientX - rect.left
					click_y = e.clientY - rect.top
				}
				else {
					let ctx = canvas1_2.getContext('2d');
					let rect = e.target.getBoundingClientRect();
					let cx = e.clientX - rect.left;
					let cy = e.clientY - rect.top;
					let radius = 1;
					
					if (rect_mask_mode == 1) {
						ctx.strokeStyle = "rgb(30, 30, 30)";
						ctx.fillStyle = "rgb(30, 30, 30)";
					}
					else if (rect_mask_mode == 2) {
						ctx.strokeStyle = "rgb(255, 255, 255)";
						ctx.fillStyle = "rgb(255, 255, 255)";
					}
					ctx.beginPath();
					ctx.arc(cx, cy, radius, 0, 2 * Math.PI, true);
					ctx.fill();
				}
			}
		}
	};
	function onMove(e) {
		if (e.buttons == 1) {
			if (rect_mask_mode == 0) {
				let ctx = canvas1_1.getContext('2d');
				let rect = e.target.getBoundingClientRect();
				let mouse_x = e.clientX - rect.left
				let mouse_y = e.clientY - rect.top

				window_x = Math.min(click_x, mouse_x)
				window_y = Math.min(click_y, mouse_y)
				window_w = Math.abs(click_x - mouse_x)
				window_h = Math.abs(click_y - mouse_y)

				ctx.clearRect(0, 0, canvas1_2.width, canvas1_2.height);
				//ctx.drawImage(image_copy, 0, 0)
				ctx.strokeStyle = "rgb(0, 0, 255)";
				ctx.strokeRect(window_x, window_y, window_w, window_h);
			}
			else {
				let ctx = canvas1_2.getContext('2d');
				let rect = e.target.getBoundingClientRect();
				let cx = e.clientX - rect.left;
				let cy = e.clientY - rect.top;
				let radius = 1;
				
				
				if (rect_mask_mode == 1) {
					ctx.strokeStyle = "rgb(30, 30, 30)";
				}
				else if (rect_mask_mode == 2) {
					ctx.strokeStyle = "rgb(255, 255, 255)";
				}
				ctx.beginPath();
				ctx.arc(cx, cy, radius, 0, 2 * Math.PI, true);
				ctx.fill();
			}
		}
	};

	function send_data() {
		if (canvas1_2) {
			const origin_data = image_copy
			const pic_data = canvas1_2.toDataURL("image/png");
			const param = {
				method: "POST",
				headers: {
					"Content-Type": "application/json; charset=utf-8"
				},
				body: JSON.stringify({origin_image:origin_data, mask_data:pic_data, wx:window_x, wy:window_y, ww:window_w, wh:window_h})
			};
			const url = API_SERVER + '/grab_cut';
			sendServer(url, param);
		}
		else {
			console.log('no picture loaded');
		}
	}

	function sendServer(url, param) {
		fetch(url, param)
			.then((response) => {
				return response.json();
			})
			.then((json) => {
				if (json.status) {
					alert("送信に『成功』しました");
					//setImage(json.result);    //json.resultにはファイル名が入っている
				}
				else {
					//alert("送信に『失敗』しました");
					console.log('hogeshi');
					let ctx = document.getElementById('canvas2').getContext('2d');
					let img = new Image();
					img.src = json.result;
					img.onload = function() {
						ctx.drawImage(img, 0, 0);
					}
				}
			})
			.catch((error) => {
				alert("送信に『失敗』しました");
				console.log(`[error2] ${error}`);
			});
	}

	

</script>
<style>
	#container {
		position: relative;
	}
    #img1 {
		position: absolute;
    	z-index: 1;

    }
	#canvas1_1 {
		position: absolute;
		z-index: 2;
	}
    #canvas1_2 {
		position: absolute;
    	z-index: 3;
    }
	#canvas2 {
		position: absolute;
	}
</style>

<body>
	<input type="file" accept="image/png, image/jpeg"
		onChange="load_to_canvas(this.files, 'img1', 'canvas1_1', 'canvas1_2', 'canvas2')"></input>
	<br>
	<form id="rect_mode_form" onChange="rect_mode_change('rect_mode_form')">
		<label><input name="rect_mode" type="radio" value="rect" checked>矩形</label>
		<label><input name="rect_mode" type="radio" value="bg">背景</label>
		<label><input name="rect_mode" type="radio" value="fg">前景</label>
		
	</form>
	<button id="upload_button" onclick="send_data()">grab cut!</button>
	<div id="container">
		<img id="img1"></img>
		<canvas id="canvas1_1"></canvas>
		<canvas id="canvas1_2"></canvas>
		<canvas id="canvas2"></canvas>
	</div>
</body>

</html>