<html lang="ja">

<script>
	let canvas1_1
	let canvas1_2
	let canvas2
	let window_x = 0;
	let window_y = 0;
	let window_w = 0;
	let window_h = 0;
	let click_x = 0;
	let click_y = 0;
	let image_copy;
	let file_name = "sample.png";
	const API_SERVER = 'https://awh.tiby.work:1443';

	function download_img() {
		if (canvas2) {
			let link = document.createElement("a");
			link.href = canvas2.toDataURL("image/png");
			let dl_file_name = "sample.png";
			let pos = file_name.lastIndexOf('.');
			if (pos != -1) {
				dl_file_name = file_name.slice(0, pos) + "_edit.png";
			}
			link.download = dl_file_name;
			link.click();
		}
	}
	function load_to_canvas(files, img_1, canvas_1_1, canvas_1_2, canvas_2) {
		canvas1_1 = document.getElementById(canvas_1_1);
		canvas1_2 = document.getElementById(canvas_1_2);
		canvas2 = document.getElementById(canvas_2);

		canvas1_2.addEventListener('mousemove', onMove, false);
		canvas1_2.addEventListener('mousedown', onClick, false);

		let rect_mode_form = document.getElementById("rect_mode_form");
		let radioNodeList = rect_mode_form.elements['rect_mode'];
		for (let elem of radioNodeList) {
			let checkValue = elem.value;
			switch(checkValue) {
				case 'rect':
					elem.checked = true;
					break;
				default:
					elem.checked = false;
					break;
			}
		}

		let reader = new FileReader();
		let image = new Image();
		reader.onloadend = function (event) {
			image.src = reader.result;
			image.onload = function () {
				canvas1_1.width = image.width;
				canvas1_1.height = image.height;
				canvas1_2.width = image.width;
				canvas1_2.height = image.height;
				window_w = image.width;
				window_h = image.height;
				canvas2.style.left = canvas1_2.width;
				image_copy = image.src
			}
			document.getElementById(img_1).setAttribute('src', event.target.result);

		}
		reader.readAsDataURL(files[0]);
		file_name = files[0].name
	}

	function onClick(e) {
		if (canvas1_2.getContext) {
			if (e.buttons == 1) {	//左クリック
				let mode = document.getElementById("rect_mode_form");
				let radioNodeList = mode.elements['rect_mode'];
				let checkValue = radioNodeList.value;
				if (checkValue == 'rect') {
					let ctx = canvas1_1.getContext('2d');
					let rect = e.target.getBoundingClientRect();
					click_x = ~~(e.clientX - rect.left);
					click_y = ~~(e.clientY - rect.top);
				}
				else {
					let ctx = canvas1_2.getContext('2d');
					let rect = e.target.getBoundingClientRect();
					let cx = ~~(e.clientX - rect.left);
					let cy = ~~(e.clientY - rect.top);
					let radius = 1;
					
					if (checkValue == 'bg') {
						ctx.strokeStyle = "rgb(30, 30, 30)";
						ctx.fillStyle = "rgb(30, 30, 30)";
					}
					else if (checkValue == 'fg') {
						ctx.strokeStyle = "rgb(255, 255, 255)";
						ctx.fillStyle = "rgb(255, 255, 255)";
					}
					ctx.beginPath();
					ctx.arc(cx, cy, radius, 0, 2 * Math.PI, true);
					ctx.fill();
				}
			}
		}
	};
	function onMove(e) {
		if (e.buttons == 1) {
			let mode = document.getElementById("rect_mode_form");
			let radioNodeList = mode.elements['rect_mode'];
			let checkValue = radioNodeList.value;
			if (checkValue == 'rect') {
				let ctx = canvas1_1.getContext('2d');
				let rect = e.target.getBoundingClientRect();
				let mouse_x = ~~(e.clientX - rect.left);
				let mouse_y = ~~(e.clientY - rect.top);

				window_x = Math.min(click_x, mouse_x)
				window_y = Math.min(click_y, mouse_y)
				window_w = Math.abs(click_x - mouse_x)
				window_h = Math.abs(click_y - mouse_y)

				ctx.clearRect(0, 0, canvas1_2.width, canvas1_2.height);
				//ctx.drawImage(image_copy, 0, 0)
				ctx.strokeStyle = "rgb(0, 0, 255)";
				ctx.strokeRect(window_x, window_y, window_w, window_h);
			}
			else {
				let ctx = canvas1_2.getContext('2d');
				let rect = e.target.getBoundingClientRect();
				let cx = ~~(e.clientX - rect.left);
				let cy = ~~(e.clientY - rect.top);
				let radius = 1;
				
				
				if (checkValue == 'bg') {
					ctx.strokeStyle = "rgb(30, 30, 30)";
					ctx.fillStyle = "rgb(30, 30, 30)";
				}
				else if (checkValue == 'fg') {
					ctx.strokeStyle = "rgb(255, 255, 255)";
					ctx.fillStyle = "rgb(255, 255, 255)";
				}
				ctx.beginPath();
				ctx.arc(cx, cy, radius, 0, 2 * Math.PI, true);
				ctx.fill();
			}
		}
	};

	function rect_mode_change(rect_mode) {
		let mode = document.getElementById(rect_mode);
		radioNodeList = mode.elements['rect_mode'];
		let checkValue = radioNodeList.value;
		let ctx = canvas1_2.getContext('2d');
		switch (checkValue) {
			case 'erase':
				ctx.globalCompositeOperation = "destination-out";
				break;
			default:
				ctx.globalCompositeOperation = "source-over";
				break;
		}
	}
	function send_data() {
		if (canvas1_2) {
			let upload_button = document.getElementById("upload_button");
			upload_button.setAttribute("disabled", true);
			upload_button.style.color = "gray";

			let output_image_size_mode = 0
			const origin_size = document.getElementById("origin_size");
			if (origin_size.checked) output_image_size_mode = 1;

			const origin_data = image_copy
			const pic_data = canvas1_2.toDataURL("image/png");
			const reduct_noise = document.getElementById("noise").checked
			console.log(reduct_noise)
			console.log(window_y)
			const param = {
				method: "POST",
				headers: {
					"Content-Type": "application/json; charset=utf-8"
				},
				body: JSON.stringify({origin_image:origin_data, mask_data:pic_data, reduct_noise:reduct_noise, output_size:output_image_size_mode, wx:window_x, wy:window_y, ww:window_w, wh:window_h})
			};
			const url = API_SERVER + '/grab_cut';
			sendServer(url, param);
		}
		else {
			console.log('no picture loaded');
		}
	}

	function sendServer(url, param) {
		fetch(url, param)
			.then((response) => {
				return response.json();
			})
			.then((json) => {
				if (json.status) {
					console.log('hogeshi');
					canvas2 = document.getElementById('canvas2')
					let img = new Image();
					img.src = json.result;
					let ctx = canvas2.getContext('2d');
					img.onload = function() {
						canvas2.style.width = img.width
						canvas2.style.height = img.height
						canvas2.width = img.width
						canvas2.height = img.height
						ctx.drawImage(img, 0, 0);
					}
				}
				else {
					console.log("送信に失敗しました");
					
				}
				let upload_button = document.getElementById("upload_button");
				upload_button.removeAttribute("disabled");
				upload_button.style.color = "black";
			})
			.catch((error) => {
				console.log("送信に失敗しました");
				console.log(error);
			});
	}

</script>
<style>
	#canvas1_1 {
		position: absolute;
		z-index: 2;
	}
    #canvas1_2 {
		position: absolute;
    	z-index: 3;
    }
	#canvas2 {
		width: 0;
		height: 0;
		position: absolute;
		background-position: 0px 0px, 7px 7px;
		background-size: 14px 14px;
		background-repeat: repeat;
		background-image:
		linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff 100%),
		linear-gradient(45deg, #fff 25%, #e3e3e3 25%, #e3e3e3 75%, #fff 75%, #fff 100%);
	}
	#container {
		position: relative;
		margin-top: 2em;
	}
	#download_img {
		margin-left: 2em;
	}
	#img1 {
		position: absolute;
    	z-index: 1;
    }
	#noise {
		margin-left: 2em;
	}
	#rect_size {
		margin-left: 2em;
	}
	#select_file {
		margin:1em;
	}

</style>

<body>
	<input type="file" id="select_file" accept="image/png, image/jpeg"
		onChange="load_to_canvas(this.files, 'img1', 'canvas1_1', 'canvas1_2', 'canvas2')"></input>
	
	<form id="rect_mode_form" onChange="rect_mode_change('rect_mode_form')"">
		<label><input name="rect_mode" type="radio" value="rect" checked>矩形</label>
		<label><input name="rect_mode" type="radio" value="bg">背景</label>
		<label><input name="rect_mode" type="radio" value="fg">前景</label>
		<label><input name="rect_mode" type="radio" value="erase">消しゴム</label>	
	</form>
	<button id="upload_button" onclick="send_data()">grab cut!</button>
	<input type="checkbox" id="noise" name="noise" checked>
	<label for="noise">ノイズ除去</label>
	<input type="radio" id="rect_size" name="rect_or_origin" value="rect_size" checked>
    <label for="rect_size">矩形抽出</label>
    <input type="radio" id="origin_size" name="rect_or_origin" value="origin_size">
	<label for="origin_size">元サイズ</label>
	<button id ="download_img" onclick="download_img()">ダウンロード</button>

	<div id="container">
		<img id="img1"></img>
		<canvas id="canvas1_1"></canvas>
		<canvas id="canvas1_2"></canvas>
		<canvas id="canvas2"></canvas>
	</div>
</body>

</html>